{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "Total Arrivals by State (Female vs Male)",
  "width": 500,
  "height": 400,
  "data": {
    "url": "aggregated_arrivals_soe.csv",
    "format": {"type": "csv"}
  },
  "transform": [
    {
      "fold": ["total_arrivals_female", "total_arrivals_male"],
      "as": ["Gender", "TotalArrivals"]
    }
  ],
  "layer": [{
    "selection": {
      "gender_selection": {
        "type": "multi",
        "fields": ["Gender"],
        "bind": "legend"
      }
    },
    "mark": "bar",
    "encoding": {
      "x": {
        "field": "soe",
        "type": "nominal",
        "title": "States"
      },
      "y": {
        "aggregate": "sum",
        "field": "TotalArrivals",
        "type": "quantitative",
        "title": "Total Arrivals"
      },
      "color": {
        "field": "Gender",
        "type": "nominal",
        "title": "Gender",
        "legend": {"labelExpr": "{'total_arrivals_female': 'Female', 'total_arrivals_male': 'Male'}[datum.label]"}
      },
      "xOffset": {
        "field": "Gender"
      },
      "tooltip": [
        {"field": "soe", "type": "nominal", "title": "State"},
        {"field": "TotalArrivals", "type": "quantitative", "title": "Total Arrivals"}
      ],
      "opacity": {
        "condition": {"selection": "gender_selection", "value": 1},
        "value": 0.3
      }
    }
  },
  {
    "mark": {
      "type": "text",
      "align": "center",
      "baseline": "bottom",
      "dy": -2,
      "fontSize": 11,
      "fontWeight": "bold"
    },
    "encoding": {
      "text": {
        "condition": {
          "test": "datum['TotalArrivals'] > 500000",  
          "field": "TotalArrivals"  
        },
        "value": "" 
      },
      "x": {
        "field": "soe",
        "type": "nominal"
      },
      "y": {
        "aggregate": "sum",
        "field": "TotalArrivals",
        "type": "quantitative"
      },
      "color": {"value": "black"}
    }
  }
  ]
}
